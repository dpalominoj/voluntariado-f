{% extends "base.html" %}

{% block title %}Ayuda - KONECTAi{% endblock %}

{% block content %}
<div class="bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="lg:text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                Centro de Ayuda y Soporte
            </h2>
            <p class="mt-4 max-w-2xl text-xl text-gray-600 lg:mx-auto">
                Encuentra respuestas a preguntas comunes y aprende cómo usar KONECTAi.
            </p>
        </div>

        <div class="mt-12 max-w-3xl mx-auto">
            <h3 class="text-2xl font-semibold text-gray-900 mb-6 text-center">Preguntas Frecuentes</h3>
            <div x-data="{ openAccordion: 1 }" class="space-y-4">
                {# Accordion Item 1 #}
                <div class="border border-gray-200 rounded-lg">
                    <button @click="openAccordion === 1 ? openAccordion = null : openAccordion = 1" class="w-full flex items-center justify-between p-4 sm:p-6 text-left text-gray-700 hover:bg-gray-100 focus:outline-none">
                        <span class="text-lg font-medium">¿Cómo me inscribo como voluntario?</span>
                        <svg class="w-6 h-6 transform transition-transform duration-200" :class="{ 'rotate-180': openAccordion === 1 }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="openAccordion === 1" x-cloak x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" class="p-4 sm:p-6 border-t border-gray-200">
                        <p class="text-base text-gray-600">
                            Para inscribirte como voluntario, primero necesitarás crear una cuenta. Una vez registrado, podrás explorar los programas y actividades disponibles e inscribirte en aquellos que te interesen.
                        </p>
                    </div>
                </div>

                {# Accordion Item 2 #}
                <div class="border border-gray-200 rounded-lg">
                    <button @click="openAccordion === 2 ? openAccordion = null : openAccordion = 2" class="w-full flex items-center justify-between p-4 sm:p-6 text-left text-gray-700 hover:bg-gray-100 focus:outline-none">
                        <span class="text-lg font-medium">¿Cómo puedo listar los programas de mi organización?</span>
                        <svg class="w-6 h-6 transform transition-transform duration-200" :class="{ 'rotate-180': openAccordion === 2 }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="openAccordion === 2" x-cloak x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" class="p-4 sm:p-6 border-t border-gray-200">
                        <p class="text-base text-gray-600">
                            Si eres un organizador, necesitarás una cuenta de 'Organizador'. Una vez aprobada, tendrás acceso a un panel donde podrás crear y gestionar tus programas y actividades.
                        </p>
                    </div>
                </div>

                {# Accordion Item 3 - Contact #}
                <div class="border border-gray-200 rounded-lg">
                    <button @click="openAccordion === 3 ? openAccordion = null : openAccordion = 3" class="w-full flex items-center justify-between p-4 sm:p-6 text-left text-gray-700 hover:bg-gray-100 focus:outline-none">
                        <span class="text-lg font-medium">¿A quién contacto para obtener ayuda?</span>
                        <svg class="w-6 h-6 transform transition-transform duration-200" :class="{ 'rotate-180': openAccordion === 3 }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="openAccordion === 3" x-cloak x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" class="p-4 sm:p-6 border-t border-gray-200">
                        <p class="text-base text-gray-600">
                            Para cualquier problema o pregunta no cubierta aquí, por favor contacta a nuestro equipo de soporte en <a href="mailto:support@konectai.example.com" class="text-indigo-600 hover:text-indigo-500">support@konectai.example.com</a>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-16 pt-10 border-t border-gray-200">
            <div class="text-center">
                 <h3 class="text-2xl font-semibold text-gray-900">¿Necesitas más Ayuda? ¡Chatea con Nosotros!</h3>
            </div>
            <!-- MODIFIED SECTION FOR CHAT INTERFACE -->
            <div class="mt-6 bg-white p-4 sm:p-6 rounded-lg shadow-md max-w-2xl mx-auto border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Chatea con Nuestro Asistente Virtual</h3>
                <!-- Chat Messages Display Area -->
                <div id="chatMessages" class="h-80 overflow-y-auto mb-4 p-3 bg-gray-50 rounded-md border border-gray-300">
                    <!-- Example Bot Message -->
                    <div class="flex justify-start mb-2">
                        <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xs shadow">
                            <p class="text-sm">Hola! Soy tu asistente virtual. Como puedo ayudarte hoy?</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Input Area -->
                <div class="flex items-center border-t border-gray-200 pt-4">
                    <input type="text" id="chatInput" class="flex-grow p-3 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Escribe tu mensaje aqui...">
                    <button id="sendChatButton" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-r-md font-semibold">
                        Enviar
                    </button>
                </div>
            </div>
            <!-- END OF MODIFIED SECTION -->
            <p class="mt-4 text-sm text-gray-500 text-center">Nuestro chatbot puede ayudar a responder preguntas comunes. Si no puede ayudarte, te guiará sobre cómo contactar a nuestro equipo de soporte.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{# {{ super() }} #} {# Uncomment if base.html defines a 'scripts' block and you want to extend it #}
<script src="https://cdn.socket.io/4.5.2/socket.io.min.js"></script>
<script>
   // Note: chatMessages, addMessageToChat are defined here for clarity,
   // but ensure they are accessible in the scope where handleSendMessage is called.
   const chatMessages = document.getElementById('chatMessages');

   function addMessageToChat(message, sender) {
        if (!chatMessages) {
            console.error("chatMessages container not found in addMessageToChat");
            return;
        }
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('flex', (sender === 'user' ? 'justify-end' : 'justify-start'), 'mb-2');

        const messageContent = document.createElement('div');
        messageContent.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'shadow', 'text-sm');
        if (sender === 'user') {
            messageContent.classList.add('bg-gray-200', 'text-gray-800');
        } else { // 'bot'
            messageContent.classList.add('bg-indigo-500', 'text-white');
        }

        const p = document.createElement('p');
        p.textContent = message; // Use textContent to prevent XSS
        messageContent.appendChild(p);

        messageWrapper.appendChild(messageContent);
        chatMessages.appendChild(messageWrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
    }

   let isBotTyping = false;

   function setBotTyping(isTyping) {
        isBotTyping = isTyping;
        const localChatInput = document.getElementById('chatInput');
        const localSendChatButton = document.getElementById('sendChatButton');
        const localChatMessages = document.getElementById('chatMessages'); // Re-fetch for safety, though global chatMessages should work.

        if (localChatInput) {
            localChatInput.disabled = isTyping;
        }
        if (localSendChatButton) {
            localSendChatButton.disabled = isTyping;
        }

        const typingIndicator = document.getElementById('botTypingIndicator');
        if (isTyping) {
            if (!typingIndicator && localChatMessages) { // Ensure localChatMessages exists
                const newTypingDiv = document.createElement('div');
                newTypingDiv.id = 'botTypingIndicator';
                newTypingDiv.classList.add('flex', 'justify-start', 'mb-2');
                newTypingDiv.innerHTML = `
                    <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xs shadow text-sm">
                        <p><em>El asistente está escribiendo...</em></p>
                    </div>`;
                localChatMessages.appendChild(newTypingDiv);
                localChatMessages.scrollTop = localChatMessages.scrollHeight;
            }
        } else {
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
    }

   function handleSendMessage() { // Removed async as socket.emit is not async in the same way
       const chatInput = document.getElementById('chatInput'); // Renamed for clarity, matches DOMContentLoaded
       const messageText = chatInput ? chatInput.value.trim() : "";

       if (messageText && !isBotTyping && window.socket) { // Check if socket is initialized
           addMessageToChat(messageText, 'user');
           window.socket.emit('chat_message', { query: messageText });
           if (chatInput) chatInput.value = '';
           setBotTyping(true);
       } else if (!messageText) {
           console.warn("Attempted to send an empty message.");
       } else if (isBotTyping) {
           console.warn("Attempted to send message while bot is typing.");
       } else if (!window.socket) {
           console.error("Socket not initialized. Cannot send message.");
           addMessageToChat("Error de conexión con el chat. Intenta recargar la página.", 'bot');
       }
   }

   document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        // chatMessages is already defined globally

        // Initialize SocketIO
        // Make socket global or pass it around if preferred, for now attaching to window for simplicity
        window.socket = io();

        window.socket.on('connect', () => {
            console.log('Socket.IO connected');
            if (chatInput) chatInput.disabled = false;
            if (sendChatButton) sendChatButton.disabled = false;
        });

        window.socket.on('disconnect', () => {
            console.log('Socket.IO disconnected');
            addMessageToChat("Se ha perdido la conexión con el chat. Por favor, recarga la página.", 'bot');
            if (chatInput) chatInput.disabled = true;
            if (sendChatButton) sendChatButton.disabled = true;
            setBotTyping(false); // Clear typing indicator if it was on
        });

        window.socket.on('chat_response', (data) => {
            setBotTyping(false);
            if (data && data.response) {
                addMessageToChat(data.response, 'bot');
                if (data.requires_auth) {
                    addMessageToChat("Por favor, inicia sesión para obtener respuestas más personalizadas.", 'bot');
                }
            } else {
                addMessageToChat("Recibida respuesta inesperada del servidor.", 'bot');
                console.error("Unexpected chat_response data:", data);
            }
        });

        window.socket.on('chat_error', (data) => {
            setBotTyping(false);
            if (data && data.message) {
                addMessageToChat(data.message, 'bot');
            } else {
                addMessageToChat("Ocurrió un error desconocido con el chat.", 'bot');
                console.error("Unknown chat_error:", data);
            }
        });

        if (sendChatButton) sendChatButton.addEventListener('click', handleSendMessage);
        if (chatInput) {
            chatInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission if it's part of a form
                    handleSendMessage();
                }
            });
        }
        // Initial state: disable input until socket connects
        if (chatInput) chatInput.disabled = true;
        if (sendChatButton) sendChatButton.disabled = true;
   });
</script>
{% endblock %}
