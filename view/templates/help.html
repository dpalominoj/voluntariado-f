{% extends "base.html" %}

{% block title %}Ayuda - KONECTAi{% endblock %}

{% block content %}
<div class="bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="lg:text-center">
            <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
                Centro de Ayuda y Soporte
            </h2>
            <p class="mt-4 max-w-2xl text-xl text-gray-600 lg:mx-auto">
                Encuentra respuestas a preguntas comunes y aprende cómo usar KONECTAi.
            </p>
        </div>

        <div class="mt-12 max-w-3xl mx-auto">
            <h3 class="text-2xl font-semibold text-gray-900 mb-6 text-center">Preguntas Frecuentes</h3>
            <div x-data="{ openAccordion: 1 }" class="space-y-4">
                {# Accordion Item 1 #}
                <div class="border border-gray-200 rounded-lg">
                    <button @click="openAccordion === 1 ? openAccordion = null : openAccordion = 1" class="w-full flex items-center justify-between p-4 sm:p-6 text-left text-gray-700 hover:bg-gray-100 focus:outline-none">
                        <span class="text-lg font-medium">¿Cómo me inscribo como voluntario?</span>
                        <svg class="w-6 h-6 transform transition-transform duration-200" :class="{ 'rotate-180': openAccordion === 1 }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="openAccordion === 1" x-cloak x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" class="p-4 sm:p-6 border-t border-gray-200">
                        <p class="text-base text-gray-600">
                            Para inscribirte como voluntario, primero necesitarás crear una cuenta. Una vez registrado, podrás explorar los programas y actividades disponibles e inscribirte en aquellos que te interesen.
                        </p>
                    </div>
                </div>

                {# Accordion Item 2 #}
                <div class="border border-gray-200 rounded-lg">
                    <button @click="openAccordion === 2 ? openAccordion = null : openAccordion = 2" class="w-full flex items-center justify-between p-4 sm:p-6 text-left text-gray-700 hover:bg-gray-100 focus:outline-none">
                        <span class="text-lg font-medium">¿Cómo puedo listar los programas de mi organización?</span>
                        <svg class="w-6 h-6 transform transition-transform duration-200" :class="{ 'rotate-180': openAccordion === 2 }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="openAccordion === 2" x-cloak x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" class="p-4 sm:p-6 border-t border-gray-200">
                        <p class="text-base text-gray-600">
                            Si eres un organizador, necesitarás una cuenta de 'Organizador'. Una vez aprobada, tendrás acceso a un panel donde podrás crear y gestionar tus programas y actividades.
                        </p>
                    </div>
                </div>

                {# Accordion Item 3 - Contact #}
                <div class="border border-gray-200 rounded-lg">
                    <button @click="openAccordion === 3 ? openAccordion = null : openAccordion = 3" class="w-full flex items-center justify-between p-4 sm:p-6 text-left text-gray-700 hover:bg-gray-100 focus:outline-none">
                        <span class="text-lg font-medium">¿A quién contacto para obtener ayuda?</span>
                        <svg class="w-6 h-6 transform transition-transform duration-200" :class="{ 'rotate-180': openAccordion === 3 }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div x-show="openAccordion === 3" x-cloak x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" class="p-4 sm:p-6 border-t border-gray-200">
                        <p class="text-base text-gray-600">
                            Para cualquier problema o pregunta no cubierta aquí, por favor contacta a nuestro equipo de soporte en <a href="mailto:support@konectai.example.com" class="text-indigo-600 hover:text-indigo-500">support@konectai.example.com</a>.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-16 pt-10 border-t border-gray-200">
            <div class="text-center">
                 <h3 class="text-2xl font-semibold text-gray-900">¿Necesitas más Ayuda? ¡Chatea con Nosotros!</h3>
            </div>
            <!-- MODIFIED SECTION FOR CHAT INTERFACE -->
            <div class="mt-6 bg-white p-4 sm:p-6 rounded-lg shadow-md max-w-2xl mx-auto border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Chatea con Nuestro Asistente Virtual</h3>
                <!-- Chat Messages Display Area -->
                <div id="chatMessages" class="h-80 overflow-y-auto mb-4 p-3 bg-gray-50 rounded-md border border-gray-300">
                    <!-- Example Bot Message -->
                    <div class="flex justify-start mb-2">
                        <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xs shadow">
                            <p class="text-sm">Hola! Soy tu asistente virtual. Como puedo ayudarte hoy?</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Input Area -->
                <div class="flex items-center border-t border-gray-200 pt-4">
                    <input type="text" id="chatInput" class="flex-grow p-3 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Escribe tu mensaje aqui...">
                    <button id="sendChatButton" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-r-md font-semibold">
                        Enviar
                    </button>
                </div>
            </div>
            <!-- END OF MODIFIED SECTION -->
            <p class="mt-4 text-sm text-gray-500 text-center">Nuestro chatbot puede ayudar a responder preguntas comunes. Si no puede ayudarte, te guiará sobre cómo contactar a nuestro equipo de soporte.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{# {{ super() }} #} {# Uncomment if base.html defines a 'scripts' block and you want to extend it #}
<script>
   // Note: chatMessages, addMessageToChat are defined here for clarity,
   // but ensure they are accessible in the scope where handleSendMessage is called.
   const chatMessages = document.getElementById('chatMessages');

   function addMessageToChat(message, sender) {
        if (!chatMessages) {
            console.error("chatMessages container not found in addMessageToChat");
            return;
        }
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('flex', (sender === 'user' ? 'justify-end' : 'justify-start'), 'mb-2');

        const messageContent = document.createElement('div');
        messageContent.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'shadow', 'text-sm');
        if (sender === 'user') {
            messageContent.classList.add('bg-gray-200', 'text-gray-800');
        } else { // 'bot'
            messageContent.classList.add('bg-indigo-500', 'text-white');
        }

        const p = document.createElement('p');
        p.textContent = message; // Use textContent to prevent XSS
        messageContent.appendChild(p);

        messageWrapper.appendChild(messageContent);
        chatMessages.appendChild(messageWrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
    }

   let isBotTyping = false;

   function setBotTyping(isTyping) {
        isBotTyping = isTyping;
        const localChatInput = document.getElementById('chatInput');
        const localSendChatButton = document.getElementById('sendChatButton');
        const localChatMessages = document.getElementById('chatMessages'); // Re-fetch for safety, though global chatMessages should work.

        if (localChatInput) localChatInput.disabled = isTyping;
        if (localSendChatButton) localSendChatButton.disabled = isTyping;

        const typingIndicator = document.getElementById('botTypingIndicator');
        if (isTyping) {
            if (!typingIndicator) {
                const newTypingDiv = document.createElement('div');
                newTypingDiv.id = 'botTypingIndicator';
                newTypingDiv.classList.add('flex', 'justify-start', 'mb-2');
                newTypingDiv.innerHTML = `
                    <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xs shadow text-sm">
                        <p><em>El asistente está escribiendo...</em></p>
                    </div>`;
                if (localChatMessages) {
                    localChatMessages.appendChild(newTypingDiv);
                    localChatMessages.scrollTop = localChatMessages.scrollHeight;
                }
            }
        } else {
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
    }

   async function handleSendMessage() {
       const localChatInput = document.getElementById('chatInput');
       const messageText = localChatInput ? localChatInput.value.trim() : "";

       if (messageText && !isBotTyping && typeof self !== 'undefined' && self.llmReady) {
           addMessageToChat(messageText, 'user');
           if (localChatInput) localChatInput.value = '';
           setBotTyping(true);

           try {
               if (typeof self.getLLMResponse === 'function') {
                   const botResponse = await self.getLLMResponse(messageText);
                   addMessageToChat(botResponse, 'bot');
               } else {
                   addMessageToChat("La función del asistente no está definida.", 'bot');
                   console.error("getLLMResponse is not a function.");
               }
           } catch (error) {
               console.error("Error getting LLM response in handleSendMessage:", error);
               addMessageToChat("Lo siento, tuve problemas para procesar tu solicitud.", 'bot');
           } finally {
               setBotTyping(false);
           }
       } else if (isBotTyping) {
           console.warn("Attempted to send message while bot is typing.");
       } else if (typeof self === 'undefined' || !self.llmReady) {
            // Add a user-facing message if LLM is not ready
            if (typeof self === 'undefined' || typeof self.llmReady === 'undefined') {
                 addMessageToChat("El asistente se está cargando. Por favor espera un momento.", 'bot');
            } else if (!self.llmReady) {
                 addMessageToChat("El asistente no está listo. Puede que haya habido un error al cargarlo.", 'bot');
            }
            console.warn("Attempted to send message, but LLM not ready or self not defined.");
       } else if (!messageText) {
           console.warn("Attempted to send an empty message.");
       }
   }

   document.addEventListener('DOMContentLoaded', function() {
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        // chatMessages is already defined globally in this script block

        const updateChatAvailability = (isReady, errorMsg = "") => {
            if (chatInput) {
                chatInput.disabled = !isReady;
                chatInput.placeholder = isReady ? "Escribe tu mensaje aqui..." : (errorMsg ? errorMsg : "Asistente cargando...");
            }
            if (sendChatButton) sendChatButton.disabled = !isReady;
        };

        // Check initial LLM state
        if (typeof self !== 'undefined' && typeof self.llmReady === 'boolean') {
            if (self.llmReady) {
                updateChatAvailability(true);
            } else { // Loading has started or failed early
                 updateChatAvailability(false, self.llmModelName ? "Asistente cargando..." : "Error al iniciar LLM.");
            }
        } else if (typeof self !== 'undefined' && self.llmPipeline === null && typeof self.llmReady === 'undefined'){
            // This case means chatbot_llm.js has run, pipeline is null (set before async call), and llmReady is not yet defined
            updateChatAvailability(false, self.llmModelName ? "Asistente cargando..." : "Iniciando LLM...");
        }
         else { // self or self.llmReady not yet defined, so still loading or transformers.js hasn't run
            updateChatAvailability(false);
        }

        window.addEventListener('llm-loading', () => {
            console.log("LLM loading event received in help.html");
            updateChatAvailability(false, "Asistente cargando...");
        });

        window.addEventListener('llm-ready', () => {
            console.log("LLM ready event received in help.html");
            updateChatAvailability(true);
            // Consider removing the initial "Hola! Soy tu asistente virtual..." if it's added by default
            // and the LLM is now ready to provide its own greeting or wait for user.
            // For now, we leave it.
        });

        window.addEventListener('llm-error', (event) => {
            console.error("LLM error event received in help.html:", event.detail);
            const message = event.detail && event.detail.message ? event.detail.message : 'Error desconocido.';
            updateChatAvailability(false, "Error al cargar asistente.");
            // Add message to chat only if chatMessages is available
            if (chatMessages) {
                addMessageToChat(`Error al cargar el asistente: ${message}. Intenta recargar la página.`, 'bot');
            }
        });

        if (sendChatButton) sendChatButton.addEventListener('click', handleSendMessage);
        if (chatInput) {
            chatInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission if it's part of a form
                    handleSendMessage();
                }
            });
        }
   });
</script>
{% endblock %}
