<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}KONECTAi - Voluntariado Inclusivo{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.userway.org/widget.js" data-account="w1p59Fihx2" data-position="5"></script>
    <style>
      /* body { padding-top: 5rem; } Tailwind will handle spacing */
      [x-cloak] { display: none !important; }
    </style>
  </head>
  <body x-data="{ openMobileMenu: false }">
    <nav class="bg-indigo-700 text-white fixed top-0 w-full shadow-lg z-50">
      <div class="container mx-auto px-4 py-3 md:flex md:items-center md:justify-between">
        <div class="flex justify-between items-center">
          <a class="text-xl hover:text-indigo-200 flex items-center" href="{{ url_for('main.home') }}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0M7.414 15.414a2 2 0 11-2.828-2.828l3-3a2 2 0 012.828 0M4 8a1 1 0 011.447-.894l4 2a1 1 0 010 1.788l-4 2A1 1 0 014 12V8z" clip-rule="evenodd" />
            </svg>
            <span class="font-bold tracking-tight">KONECT</span><span class="font-medium tracking-tight text-indigo-400">Ai</span>
          </a>
          
          <!-- Icono de Notificacion Movil-->
          <div class="md:hidden flex items-center">
            <button class="p-2 rounded-full text-white hover:text-gray-300 focus:outline-none focus:bg-gray-700" aria-label="Notifications_mobile">
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
              </svg>
            </button>
            
            <!-- Icono de Menu Movil -->
            <button @click="openMobileMenu = !openMobileMenu" type="button" class="p-2 rounded-full text-white hover:text-gray-300 focus:outline-none focus:bg-gray-700 transition duration-200 ease-in-out"  aria-label="Menu_mobile">
              <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 12h16" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 18h16" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile Menu / Desktop Links -->
        <div :class="{'block': openMobileMenu, 'hidden': !openMobileMenu}" class="mobile-menu-container md:flex md:items-center w-full md:w-auto md:bg-transparent shadow-lg md:shadow-none" x-cloak>
          <ul class="md:flex flex-col md:flex-row md:space-x-4 mt-4 md:mt-0 text-indigo-100">
            <li><a href="{{ url_for('main.home') }}" class="nav-link block py-2 px-3 text-indigo-100 hover:bg-indigo-600 hover:text-white rounded">Inicio</a></li>
            <li><a href="{{ url_for('main.programs') }}" class="nav-link block py-2 px-3 text-indigo-100 hover:bg-indigo-600 hover:text-white rounded">Programas</a></li>
            <li><a href="{{ url_for('main.help_page') }}" class="nav-link block py-2 px-3 text-indigo-100 hover:bg-indigo-600 hover:text-white rounded">Ayuda</a></li>
          </ul>

          <ul class="md:flex md:items-center flex-col md:flex-row md:space-x-4 mt-4 md:mt-0 md:ml-auto text-indigo-100">
            {% if current_user.is_authenticated %}
            <li class="mr-2 hidden md:block"> {# Or ml-2 depending on placement relative to user menu #}
              <button class="p-2 rounded-full text-white hover:text-indigo-200 focus:outline-none focus:bg-indigo-600" aria-label="Notifications">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
              </button>
            </li>
            <li class="relative" x-data="{ openUserMenu: false }" @click.away="openUserMenu = false">
              <button @click="openUserMenu = !openUserMenu" class="flex items-center w-full text-left py-2 px-3 text-white hover:text-indigo-200 rounded focus:outline-none focus:bg-indigo-600">
                <svg class="h-6 w-6 mr-2 inline-block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
                {{ current_user.nombre }} ({{ current_user.perfil | capitalize }})
                <svg class="h-5 w-5 ml-1 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"></path></svg>
              </button>
              <div x-show="openUserMenu" x-cloak class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 ring-1 ring-black ring-opacity-5">
                <a href="{{ url_for('user_dashboard.dashboard') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">Mi Panel</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">Configuración</a>
                <hr class="border-t border-gray-200 my-1">
                <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50">Cerrar Sesión</a>
              </div>
            </li>
            {% else %}
            <li><a href="{{ url_for('auth.login') }}" class="block py-2 px-3 text-indigo-100 hover:bg-indigo-600 hover:text-white rounded">Iniciar Sesión</a></li>
            <li><a href="{{ url_for('auth.register') }}" class="block py-2 px-3 text-indigo-100 hover:bg-indigo-600 hover:text-white rounded">Registrarse</a>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-4 mt-24">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {# Define color classes based on category #}
            {% set alert_classes = {
              'info': 'bg-blue-100 border-blue-500 text-blue-700',
              'success': 'bg-green-100 border-green-500 text-green-700',
              'warning': 'bg-yellow-100 border-yellow-500 text-yellow-700',
              'danger': 'bg-red-100 border-red-500 text-red-700',
              'error': 'bg-red-100 border-red-500 text-red-700',
              'message': 'bg-gray-100 border-gray-500 text-gray-700'
            } %}
            {% set chosen_class = alert_classes.get(category, alert_classes['message']) %}
            <div class="{{ chosen_class }} border-l-4 p-4 mb-4 relative" role="alert" x-data="{ show: true }" x-show="show" x-transition x-cloak>
              <div class="flex">
                <div class="py-1">
                  {% if category == 'info' %}
                    <svg class="fill-current h-6 w-6 text-blue-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v2H9zm0 4V13h2v2H9z"/></svg>
                  {% elif category == 'success' %}
                    <svg class="fill-current h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM6.7 9.29L9 11.6l4.3-4.3 1.4 1.42L9 14.4l-3.7-3.7 1.4-1.42z"/></svg>
                  {% elif category == 'warning' %}
                    <svg class="fill-current h-6 w-6 text-yellow-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 5v6h2V5H9zm0 8v2h2v-2H9z"/></svg>
                  {% elif category == 'error' or category == 'danger' %}
                    <svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v2H9zm0 4V13h2v2H9zm6.36-3.64A4.002 4.002 0 0112 14a4 4 0 01-4-4c0-1.48.8-2.77 2-3.46V4h4v2.54c1.2.69 2 1.98 2 3.46z" fill-rule="evenodd" clip-rule="evenodd"/></svg>
                  {% endif %}
                </div>
                <div class="flex-grow">
                  <p class="font-bold capitalize">{{ 'Error' if category == 'danger' else category|capitalize }}</p> {# Display 'Error' for 'danger' category, capitalize others #}
                  <p class="text-sm">{{ message }}</p>
                </div>
                <button @click="show = false" type="button" class="ml-auto -mx-1.5 -my-1.5 p-1.5 inline-flex h-8 w-8 items-center justify-center rounded-lg focus:ring-2 {{ chosen_class.replace('bg-', 'focus:ring-').replace('border-', 'hover:bg-').replace('100', '200').replace('text-', 'hover:text-') }}">
                  <span class="sr-only">Descartar</span>
                  <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>

    <footer class="container mx-auto mt-10 py-6 text-center text-gray-500 border-t border-gray-200">
      copyright 2025 KONECTAi - Voluntariado Inclusivo
    </footer>

    {#{% block scripts %}#}
    {# Any page-specific scripts could go here #}
    {#{% endblock %}#}

    <div x-data="{ openChatOptions: false }" class="fixed bottom-6 right-6 z-50">
        <!-- Chat Options Menu -->
        <div x-show="openChatOptions"
             x-cloak
             @click.away="openChatOptions = false"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="absolute bottom-16 right-0 mb-2 w-60 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5">
            <a href="#" id="voiceInteractionBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700">
                Interacción por voz
            </a>
            <a href="{{ url_for('main.help_page') }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700">
                Interacción por chat
            </a>
        </div>

        <!-- FAB Icon -->
        <button @click="openChatOptions = !openChatOptions"
           class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center"
           aria-label="Open Chat Options">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.755 4 3.985 0 1.307-.486 2.498-1.336 3.28A7.493 7.493 0 0112 17.5c-.897 0-1.73-.297-2.433-.816l-.764-.625V15.5a1 1 0 00-1-1h-.5a1 1 0 00-1 1v2.158l-.623.624a3.007 3.007 0 00-1.09 2.158V21h14v-.258c0-.845-.414-1.632-1.09-2.158l-.624-.624V16.5a1 1 0 00-1-1h-.5a1 1 0 00-1 1v.039l.008.014c.005.009.012.019.02.03.052.066.114.136.186.213.145.157.312.304.498.438.228.164.48.304.752.408.27.102.556.157.858.157.976 0 1.83-.37 2.465-1.003.642-.64 1.035-1.503 1.035-2.488 0-2.758-2.246-4.986-5-4.986-2.044 0-3.754.977-4.46 2.486L8.228 9z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6a3.5 3.5 0 100-7 3.5 3.5 0 000 7z" />
            </svg>
            <span class="sr-only">Abrir opciones de chat</span>
        </button>
    </div>

<!-- Voice Chat Modal -->
<div x-data="{ voiceModalOpen: false }" x-show="voiceModalOpen" x-cloak
     @open-voice-modal.window="voiceModalOpen = true" @close-voice-modal.window="voiceModalOpen = false"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-60 flex items-center justify-center p-4">

    <div @click.away="voiceModalOpen = false" class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg mx-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Interacción por Voz</h3>
            <button @click="voiceModalOpen = false" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Conversation Display Area -->
        <div id="voiceChatMessages" class="h-64 overflow-y-auto mb-4 p-3 bg-gray-50 rounded-md border border-gray-300 space-y-2">
            <!-- Example Bot Message -->
            <div class="flex justify-start">
                <div class="bg-indigo-500 text-white p-3 rounded-lg max-w-xs shadow">
                    <p class="text-sm">Hola! Habla para comenzar. Di "Ayuda" para ver comandos.</p>
                </div>
            </div>
            <!-- User messages and further bot responses will be added here -->
        </div>

        <!-- Status/Transcribed Text Area -->
        <div id="voiceStatus" class="mb-4 p-2 text-sm text-gray-600 border rounded-md min-h-[40px]">
            Esperando comando...
        </div>

        <!-- Controls -->
        <div class="flex justify-center items-center space-x-4">
            <button id="toggleVoiceRecordingBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
                Iniciar Grabación
            </button>
            <!-- Future controls like a stop button or settings could go here -->
        </div>
         <p class="text-xs text-gray-500 mt-3 text-center">Esta función utiliza la API de Voz de tu navegador. Se te pedirá permiso para usar el micrófono.</p>
    </div>
</div>

<!-- Transformers.js and our custom LLM logic -->
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0"></script>
<script src="/services/chatbot_llm.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const voiceInteractionBtn = document.getElementById('voiceInteractionBtn');
    const toggleVoiceRecordingBtn = document.getElementById('toggleVoiceRecordingBtn');
    const voiceStatusDiv = document.getElementById('voiceStatus');
    const voiceChatMessagesDiv = document.getElementById('voiceChatMessages');
    let isRecording = false;
    let recognition; // Keep recognition defined here, will be initialized by initializeVoiceChat

    // Check for browser support early
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SpeechSynthesis = window.speechSynthesis;

    if (voiceInteractionBtn) {
        voiceInteractionBtn.addEventListener('click', (event) => {
            event.preventDefault();
            window.dispatchEvent(new CustomEvent('open-voice-modal'));

            const updateUIAfterLLMCheck = () => {
                if (typeof self !== 'undefined' && self.llmReady) {
                    if(voiceStatusDiv) voiceStatusDiv.textContent = 'Esperando comando...';
                    if(toggleVoiceRecordingBtn) {
                        toggleVoiceRecordingBtn.disabled = false;
                        toggleVoiceRecordingBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>Iniciar Grabación';
                        toggleVoiceRecordingBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'bg-yellow-500', 'hover:bg-yellow-600');
                        toggleVoiceRecordingBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    }
                } else if (typeof self !== 'undefined' && !self.llmReady) { // LLM loading or error
                    if(voiceStatusDiv) voiceStatusDiv.textContent = (self.llmPipeline === null && !self.llmReady) ? 'Asistente de voz cargando...' : 'Asistente de voz no disponible.';
                    if(toggleVoiceRecordingBtn) {
                        toggleVoiceRecordingBtn.disabled = true;
                        toggleVoiceRecordingBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        toggleVoiceRecordingBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-yellow-500', 'hover:bg-yellow-600');
                    }
                }
            };
            updateUIAfterLLMCheck(); // Initial check when modal opens

            if (typeof initializeVoiceChat === "function" && !recognition) {
                initializeVoiceChat(); // This will define 'recognition'
            }
        });
    }

    if (!SpeechRecognition) {
        if(voiceStatusDiv) voiceStatusDiv.textContent = 'Tu navegador no soporta reconocimiento de voz.';
        if(toggleVoiceRecordingBtn) {
            toggleVoiceRecordingBtn.disabled = true;
            toggleVoiceRecordingBtn.textContent = 'No Soportado';
        }
    }
    if (!SpeechSynthesis) {
        console.warn('Tu navegador no soporta síntesis de voz.');
    }

    function initializeVoiceChat() {
        if (!SpeechRecognition || !toggleVoiceRecordingBtn || recognition) return;

        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.interimResults = true;
        recognition.continuous = false;

        recognition.onresult = async (event) => { // Make it async
            let transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');

            if(voiceStatusDiv) voiceStatusDiv.textContent = transcript; // Show interim results

            if (event.results[0].isFinal) {
                if(voiceStatusDiv) voiceStatusDiv.textContent = 'Procesando: ' + transcript;
                addMessageToVoiceChat(transcript, 'user');

                if(voiceStatusDiv) voiceStatusDiv.textContent = 'El asistente está pensando...';
                if(toggleVoiceRecordingBtn) toggleVoiceRecordingBtn.disabled = true;

                try {
                    if (typeof self !== 'undefined' && self.llmReady && typeof self.getLLMResponse === 'function') {
                        const botResponseText = await self.getLLMResponse(transcript);
                        addMessageToVoiceChat(botResponseText, 'bot');
                        speakMessage(botResponseText);
                    } else {
                        const unavailableMsg = "El asistente no está disponible en este momento.";
                        addMessageToVoiceChat(unavailableMsg, 'bot');
                        speakMessage(unavailableMsg);
                        console.warn("LLM not ready or getLLMResponse not defined for voice chat.");
                    }
                } catch (error) {
                    console.error("Error getting LLM response for voice chat:", error);
                    const errorMsg = "Lo siento, tuve problemas para procesar tu audio.";
                    addMessageToVoiceChat(errorMsg, 'bot');
                    speakMessage(errorMsg);
                } finally {
                    if(voiceStatusDiv && voiceStatusDiv.textContent === 'El asistente está pensando...') {
                       voiceStatusDiv.textContent = 'Esperando comando...';
                    }
                    if(toggleVoiceRecordingBtn) {
                        toggleVoiceRecordingBtn.disabled = (typeof self === 'undefined' || !self.llmReady);
                        if (typeof self !== 'undefined' && self.llmReady && !isRecording) { // Reset button to "Start Recording" if LLM is ready and not currently recording
                             toggleVoiceRecordingBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>Iniciar Grabación';
                             toggleVoiceRecordingBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'bg-gray-400', 'cursor-not-allowed');
                             toggleVoiceRecordingBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                        } else if (typeof self === 'undefined' || !self.llmReady) {
                            toggleVoiceRecordingBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                            toggleVoiceRecordingBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-yellow-500', 'hover:bg-yellow-600');
                        }
                    }
                    // Since recognition.continuous is false, recognition stops automatically.
                    // The 'isRecording' state should be false here. If not, call stopRecording().
                    if (isRecording) {
                        stopRecording(); // This will also update button state.
                    }
                }
            }
        };

        recognition.onerror = (event) => {
            if(voiceStatusDiv) voiceStatusDiv.textContent = 'Error en reconocimiento: ' + event.error;
            stopRecording();
        };

        recognition.onend = () => {
            if (isRecording) {
                stopRecording();
            }
        };

        if(toggleVoiceRecordingBtn) {
            toggleVoiceRecordingBtn.removeEventListener('click', toggleRecordingHandler);
            toggleVoiceRecordingBtn.addEventListener('click', toggleRecordingHandler);
        }
    }

    function toggleRecordingHandler() {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }

    function startRecording() {
        if (!recognition) {
            if(voiceStatusDiv) voiceStatusDiv.textContent = 'Reconocimiento de voz no inicializado.';
            return;
        }
        if (typeof self === 'undefined' || !self.llmReady) {
            if(voiceStatusDiv) voiceStatusDiv.textContent = 'El asistente aún no está listo. Intenta más tarde.';
            if(toggleVoiceRecordingBtn) {
                toggleVoiceRecordingBtn.disabled = true;
                toggleVoiceRecordingBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                toggleVoiceRecordingBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            }
            return;
        }
        try {
            recognition.start();
            isRecording = true;
            if(toggleVoiceRecordingBtn) {
                toggleVoiceRecordingBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79zM21 12.79A7.5 7.5 0 0012.79 3M3.75 12a8.25 8.25 0 0014.44 5.335" /></svg>Detener Grabación';
                toggleVoiceRecordingBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-gray-400', 'cursor-not-allowed');
                toggleVoiceRecordingBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                toggleVoiceRecordingBtn.disabled = false;
            }
            if(voiceStatusDiv) voiceStatusDiv.textContent = 'Escuchando...';
        } catch (e) {
            if(voiceStatusDiv) voiceStatusDiv.textContent = 'No se pudo iniciar la grabación: ' + e.message;
            isRecording = false;
        }
    }

    function stopRecording() {
        if (!recognition) return;
        if (isRecording) {
            recognition.stop();
        }
        isRecording = false;
        if(toggleVoiceRecordingBtn) {
            // General case: Reset to "Start Recording" if LLM is ready, otherwise disable
            if (typeof self !== 'undefined' && self.llmReady) {
                toggleVoiceRecordingBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>Iniciar Grabación';
                toggleVoiceRecordingBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'bg-gray-400', 'cursor-not-allowed');
                toggleVoiceRecordingBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                toggleVoiceRecordingBtn.disabled = false;
            } else {
                toggleVoiceRecordingBtn.disabled = true;
                toggleVoiceRecordingBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                toggleVoiceRecordingBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-yellow-500', 'hover:bg-yellow-600');
            }
        }
        if(voiceStatusDiv && voiceStatusDiv.textContent === 'Escuchando...') {
             voiceStatusDiv.textContent = 'Grabación detenida. Esperando comando...';
        }
    }

    function addMessageToVoiceChat(message, sender) {
        if (!voiceChatMessagesDiv) return;
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('flex', (sender === 'user' ? 'justify-end' : 'justify-start'), 'mb-2');

        const messageContent = document.createElement('div');
        messageContent.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'shadow', 'text-sm');
        if (sender === 'user') {
            messageContent.classList.add('bg-gray-200', 'text-gray-800');
        } else {
            messageContent.classList.add('bg-indigo-500', 'text-white');
        }
        const p = document.createElement('p');
        p.textContent = message;
        messageContent.appendChild(p);
        messageWrapper.appendChild(messageContent);
        voiceChatMessagesDiv.appendChild(messageWrapper);
        voiceChatMessagesDiv.scrollTop = voiceChatMessagesDiv.scrollHeight;
    }

    function speakMessage(message) {
        if (!SpeechSynthesis) return;
        SpeechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'es-ES';
        SpeechSynthesis.speak(utterance);
    }

    const alpineVoiceModalData = () => document.querySelector('[x-data*="voiceModalOpen"]') ? document.querySelector('[x-data*="voiceModalOpen"]').__x.$data : { voiceModalOpen: false };

    window.addEventListener('llm-loading', () => {
        if (alpineVoiceModalData().voiceModalOpen) {
            if(voiceStatusDiv) voiceStatusDiv.textContent = 'Asistente de voz cargando...';
            if(toggleVoiceRecordingBtn) {
                toggleVoiceRecordingBtn.disabled = true;
                toggleVoiceRecordingBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                toggleVoiceRecordingBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-yellow-500', 'hover:bg-yellow-600');
            }
        }
    });

    window.addEventListener('llm-ready', () => {
        if (alpineVoiceModalData().voiceModalOpen) {
            if(voiceStatusDiv && (voiceStatusDiv.textContent === 'Asistente de voz cargando...' || voiceStatusDiv.textContent === 'Asistente de voz no disponible.' || voiceStatusDiv.textContent === 'El asistente aún no está listo. Intenta más tarde.')) {
                voiceStatusDiv.textContent = 'Esperando comando...';
            }
            if(toggleVoiceRecordingBtn) {
                toggleVoiceRecordingBtn.disabled = false;
                toggleVoiceRecordingBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'bg-yellow-500', 'hover:bg-yellow-600');
                toggleVoiceRecordingBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                if (!isRecording) {
                     toggleVoiceRecordingBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>Iniciar Grabación';
                }
            }
        }
    });

    window.addEventListener('llm-error', (event) => {
         if (alpineVoiceModalData().voiceModalOpen) {
            if(voiceStatusDiv) voiceStatusDiv.textContent = 'Error del asistente. No disponible.';
            if(toggleVoiceRecordingBtn) {
                toggleVoiceRecordingBtn.disabled = true;
                toggleVoiceRecordingBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                toggleVoiceRecordingBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-yellow-500', 'hover:bg-yellow-600');
            }
            console.error("LLM error impacting voice chat:", event.detail);
        }
    });
});
</script>
  </body>
</html>
